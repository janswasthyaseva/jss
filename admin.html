<!DOCTYPE html>
<html>
<head>
  <title>JSS Admin – Patient Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; background:#f4f6f8; padding:20px; }
    h2 { margin-bottom:10px; }
    .card { background:#fff; padding:15px; border-radius:6px; margin-bottom:15px; }
    .patient { padding:10px; border-bottom:1px solid #ddd; cursor:pointer; }
    .badge { padding:4px 8px; border-radius:4px; font-size:12px; }
    .under { background:#ffc107; }
    .done { background:#28a745; color:#fff; }
    .timeline { border-left:3px solid #007bff; padding-left:15px; margin-top:10px; }
    .event { margin-bottom:12px; }
    .event-title { font-weight:bold; }
    button { padding:10px 14px; background:#007bff; color:#fff; border:none; border-radius:4px; }
  </style>
</head>

<body>

<h2>Admin – Patient Timeline</h2>

<div class="card">
  <label>Hospital ID</label>
  <input id="hid" placeholder="Enter Hospital ID">
  <button onclick="loadPatients()">Load Patients</button>
</div>

<div class="card" id="patientList"></div>

<div class="card" id="timeline" style="display:none">
  <h3 id="patientTitle"></h3>
  <div id="timelineBody" class="timeline"></div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx_gAByhgJTy9k7KcS983n3vWpoeI2w-QTj0Uq9xZqaCNbWZsUeyX6UngNdL-5L6XJX/exec";

/* ---------------- LOAD PATIENT LIST ---------------- */
async function loadPatients() {
  const hospitalId = hid.value.trim();
  if (!hospitalId) return alert("Enter Hospital ID");

  const res = await fetch(`${WEBAPP_URL}?action=ADMIN_PATIENTS&hospital_id=${hospitalId}`);
  const data = await res.json();

  patientList.innerHTML = "<h3>Patients</h3>";

  data.forEach(p => {
    const div = document.createElement("div");
    div.className = "patient";
    div.innerHTML = `
      <b>${p.name}</b> (${p.age}/${p.gender}) 
      <span class="badge ${p.status === "DISCHARGED" ? "done" : "under"}">
        ${p.status}
      </span>
    `;
    div.onclick = () => loadTimeline(p.system_patient_id, p.name);
    patientList.appendChild(div);
  });
}

/* ---------------- LOAD FULL TIMELINE ---------------- */
async function loadTimeline(pid, name) {
  const res = await fetch(`${WEBAPP_URL}?action=ADMIN_TIMELINE&patient_id=${pid}`);
  const data = await res.json();

  timeline.style.display = "block";
  patientTitle.innerText = `Patient: ${name}`;
  timelineBody.innerHTML = "";

  data.forEach(e => {
    const div = document.createElement("div");
    div.className = "event";
    div.innerHTML = `
      <div class="event-title">${e.type} – ${e.time}</div>
      <div>${e.content}</div>
    `;
    timelineBody.appendChild(div);
  });
}
</script>

</body>
</html>