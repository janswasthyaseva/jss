<!DOCTYPE html>
<html>
<head>
  <title>Nurse Triage – Jan Swasthya Seva</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; margin:20px; background:#f4f6f8; }
    h2 { border-bottom:1px solid #ccc; padding-bottom:5px; }

    .section {
      background:#fff;
      padding:15px;
      margin-bottom:20px;
      border-radius:6px;
    }

    label {
      font-weight:bold;
      display:block;
      margin-top:10px;
    }

    input, textarea, select {
      width:100%;
      padding:10px;
      margin-top:5px;
      font-size:15px;
    }

    button {
      width:100%;
      padding:14px;
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:6px;
      font-size:16px;
      cursor:pointer;
    }
  </style>
</head>

<body>

<h2>Nurse Triage</h2>

<!-- PATIENT -->
<div class="section">
  <label>Patient (Admitted Only) *</label>
  <select id="hospitalPatientId"></select>
</div>

<!-- VITALS -->
<div class="section">
  <h3>Vitals</h3>

  <label>Blood Pressure (BP)</label>
  <input id="bp" placeholder="120/80">

  <label>Heart Rate (HR)</label>
  <input id="hr" placeholder="beats/min">

  <label>SpO₂</label>
  <input id="spo2" placeholder="%">

  <label>Respiratory Rate (RR)</label>
  <input id="rr" placeholder="breaths/min">

  <label>Temperature</label>
  <input id="temp" placeholder="°C">

  <label>RBS / HGT</label>
  <input id="rbs" placeholder="mg/dL">
</div>

<!-- RISK -->
<div class="section">
  <h3>Assessment</h3>

  <label>Risk Flag *</label>
  <select id="riskFlag">
    <option value="Normal">Normal</option>
    <option value="Watch">Watch</option>
    <option value="Escalate">Escalate</option>
  </select>

  <label>Nurse Note</label>
  <textarea id="nurseNote"
    placeholder="Any observation / concern..."></textarea>
</div>

<!-- NURSE -->
<div class="section">
  <label>Nurse Name *</label>
  <input id="nurseName">
</div>

<button onclick="saveTriage()">Save Triage Entry</button>

<script>
/* ================= CONFIG ================= */
const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbx_gAByhgJTy9k7KcS983n3vWpoeI2w-QTj0Uq9xZqaCNbWZsUeyX6UngNdL-5L6XJX/exec";

const hid = new URLSearchParams(window.location.search).get("hid");

/* ================= LOAD ADMITTED PATIENTS ================= */
async function loadPatients() {
  const res = await fetch(
    WEBAPP_URL +
      "?action=getAdmittedPatients&hospital_id=" + hid
  );
  const out = await res.json();

  const sel = document.getElementById("hospitalPatientId");
  sel.innerHTML = "";

  if (out.status !== "success" || out.data.length === 0) {
    const o = document.createElement("option");
    o.textContent = "No admitted patients";
    o.disabled = true;
    sel.appendChild(o);
    return;
  }

  out.data.forEach(p => {
    const o = document.createElement("option");
    o.value = p.hospital_patient_id;
    o.textContent =
      p.hospital_patient_id + " — " + p.patient_name;
    sel.appendChild(o);
  });
}

/* ================= SAVE TRIAGE ================= */
async function saveTriage() {
  if (!hospitalPatientId.value || !nurseName.value) {
    alert("Patient and Nurse Name are required");
    return;
  }

  const payload = {
    action: "saveNurseTriage",
    hospital_id: hid,
    hospital_patient_id: hospitalPatientId.value,
    bp: bp.value,
    hr: hr.value,
    spo2: spo2.value,
    rr: rr.value,
    temp: temp.value,
    rbs: rbs.value,
    nurse_note: nurseNote.value,
    risk_flag: riskFlag.value,
    nurse_name: nurseName.value
  };

  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const out = await res.json();

  if (out.status === "TRIAGE_SAVED") {
    alert("Triage saved successfully");
    bp.value = hr.value = spo2.value =
    rr.value = temp.value = rbs.value =
    nurseNote.value = "";
    riskFlag.value = "Normal";
  } else {
    alert(out.error || "Unable to save triage");
  }
}

/* ================= BOOT ================= */
loadPatients();
</script>

</body>
</html>