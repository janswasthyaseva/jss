<!DOCTYPE html>
<html>
<head>
  <title>Patient Discharge – Jan Swasthya Seva</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; margin:20px; background:#f8f9fa; }
    h2 { border-bottom:1px solid #ccc; padding-bottom:5px; }

    .section {
      background:#fff;
      padding:15px;
      margin-bottom:20px;
      border-radius:6px;
    }

    label {
      font-weight:bold;
      display:block;
      margin-top:10px;
    }

    input, textarea, select {
      width:100%;
      padding:10px;
      margin-top:5px;
      font-size:15px;
    }

    button {
      width:100%;
      padding:15px;
      font-size:18px;
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }

    @media print {
      button { display:none; }
      body { background:#fff; }
    }
  </style>
</head>

<body>

<h2>Discharge Summary</h2>

<!-- STATUS BANNER -->
<div id="statusBanner"
     style="display:none;
            background:#e8f5e9;
            color:#2e7d32;
            padding:10px;
            margin-bottom:15px;
            border-radius:6px;
            font-weight:bold;">
  ✔ Discharge completed. This record is now read-only.
</div>

<!-- HOSPITAL -->
<div class="section">
  <label>Hospital Name</label>
  <input id="hospitalName" readonly>
</div>

<!-- PATIENT SELECTION -->
<div class="section">
  <label>Hospital Patient ID *</label>
  <select id="hospitalPatientId"></select>
</div>

<!-- CLINICAL SUMMARY -->
<div class="section">
  <h3>Clinical Summary</h3>

  <label>Final Diagnosis *</label>
  <textarea id="diagnosis"></textarea>

  <label>Medicines *</label>
  <textarea id="medicines"></textarea>

  <label>Follow-up Advice</label>
  <textarea id="followup"></textarea>

  <label>Risk Level *</label>
  <select id="risk">
    <option value="">Select</option>
    <option>Low</option>
    <option>Medium</option>
    <option>High</option>
  </select>
</div>

<!-- DOCTOR -->
<div class="section">
  <h3>Treating Doctor</h3>

  <label>Doctor Name *</label>
  <input id="doctorName">

  <label>Registration Number *</label>
  <input id="doctorReg">
</div>

<!-- DISCHARGE TIME -->
<div class="section">
  <label>Discharge Date & Time</label>
  <input id="dischargeTime" readonly>
</div>

<button onclick="finaliseDischarge()">Generate / Download / Print PDF</button>

<script>
/* ================= CONFIG ================= */
const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbx_gAByhgJTy9k7KcS983n3vWpoeI2w-QTj0Uq9xZqaCNbWZsUeyX6UngNdL-5L6XJX/exec";

const hid = new URLSearchParams(window.location.search).get("hid");

/* ================= INIT ================= */
document.getElementById("dischargeTime").value =
  new Date().toLocaleString();

/* ================= LOAD HOSPITAL ================= */
async function loadHospital() {
  const res = await fetch(WEBAPP_URL + "?hid=" + hid);
  const out = await res.json();
  if (out.name) hospitalName.value = out.name;
}

/* ================= LOAD ADMITTED PATIENTS ================= */
async function loadPatients() {
  const res = await fetch(
    WEBAPP_URL +
      "?action=getAdmittedPatients&hospital_id=" + hid
  );
  const out = await res.json();

  const sel = document.getElementById("hospitalPatientId");
  sel.innerHTML = "";

  if (out.status !== "success" || out.data.length === 0) {
    const o = document.createElement("option");
    o.textContent = "No admitted patients";
    o.disabled = true;
    sel.appendChild(o);
    return;
  }

  out.data.forEach(p => {
    const o = document.createElement("option");
    o.value = p.hospital_patient_id;
    o.textContent =
      p.hospital_patient_id + " — " + p.patient_name;
    sel.appendChild(o);
  });

  loadAutoFill(sel.value);
}

/* ================= AUTO-FILL FROM LAST CLINICAL NOTE ================= */
async function loadAutoFill(pid) {
  if (!pid) return;

  const res = await fetch(
    WEBAPP_URL +
      "?action=getDischargeAutoFill" +
      "&hospital_id=" + hid +
      "&hospital_patient_id=" + pid
  );

  const out = await res.json();

  if (out.status === "success" && out.data.hasData) {
    diagnosis.value = out.data.diagnosis || "";
    medicines.value = out.data.medicines || "";
    doctorName.value = out.data.doctor_name || "";
    doctorReg.value = out.data.doctor_reg_no || "";
  } else {
    diagnosis.value = "";
    medicines.value = "";
    doctorName.value = "";
    doctorReg.value = "";
  }
}

/* ================= LOCK UI AFTER DISCHARGE ================= */
function lockDischargeUI() {
  document
    .querySelectorAll("input, textarea, select, button")
    .forEach(el => el.disabled = true);

  document.getElementById("statusBanner").style.display = "block";
}

/* ================= FINALISE DISCHARGE ================= */
async function finaliseDischarge() {
  const payload = {
    hospital_id: hid,
    hospital_patient_id: hospitalPatientId.value,
    diagnosis: diagnosis.value,
    medicines: medicines.value,
    followup: followup.value,
    risk: risk.value,
    doctor_name: doctorName.value,
    doctor_reg_no: doctorReg.value,
    discharge_datetime: new Date().toISOString()
  };

  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const out = await res.json();

  if (out.status === "DISCHARGED") {
    lockDischargeUI();
    window.print();
  } else {
    alert(out.error || "Discharge failed");
  }
}

/* ================= EVENTS ================= */
hospitalPatientId.addEventListener("change", function () {
  loadAutoFill(this.value);
});

/* ================= BOOT ================= */
loadHospital();
loadPatients();
</script>

</body>
</html>