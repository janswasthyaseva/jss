<!DOCTYPE html>
<html>
<head>
  <title>JSS – Doctor Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; background:#f4f6f8; padding:15px; }
    h2 { margin-bottom:10px; }
    .card { background:#fff; padding:15px; border-radius:6px; margin-bottom:15px; }
    label { font-weight:bold; display:block; margin-top:10px; }
    input, select, textarea {
      width:100%; padding:10px; margin-top:5px; font-size:15px;
    }
    button {
      margin-top:12px;
      padding:12px;
      width:100%;
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:6px;
      font-size:16px;
    }
    .note {
      border-left:4px solid #007bff;
      padding-left:10px;
      margin-bottom:10px;
      font-size:14px;
    }
    .small { font-size:12px; color:#555; }
  </style>
</head>

<body>

<h2>Doctor Console</h2>

<div class="card">
  <label>Hospital ID</label>
  <input id="hid" placeholder="Hospital ID">

  <label>Patient</label>
  <select id="patientSelect"></select>

  <label>Doctor Name</label>
  <input id="doctorName">

  <label>Registration Number</label>
  <input id="doctorReg">

  <label>Visit Type</label>
  <select id="noteType">
    <option>OPD</option>
    <option>IPD</option>
  </select>
</div>

<div class="card">
  <h3>Clinical Note</h3>

  <label>Chief Complaints / Findings</label>
  <textarea id="noteContent" rows="6"></textarea>

  <button onclick="saveNote()">Save Note</button>
</div>

<div class="card">
  <h3>Previous Notes</h3>
  <div id="notes"></div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbx_gAByhgJTy9k7KcS983n3vWpoeI2w-QTj0Uq9xZqaCNbWZsUeyX6UngNdL-5L6XJX/exec";

/* ================= LOAD PATIENTS ================= */
async function loadPatients() {
  if (!hid.value) return;

  const res = await fetch(`${WEBAPP_URL}?action=ADMIN_PATIENTS&hospital_id=${hid.value}`);
  const data = await res.json();

  patientSelect.innerHTML = "";
  data.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.system_patient_id;
    opt.text = `${p.system_patient_id} – ${p.name}`;
    patientSelect.appendChild(opt);
  });

  loadNotes();
}

hid.onchange = loadPatients;
patientSelect.onchange = loadNotes;

/* ================= LOAD NOTES ================= */
async function loadNotes() {
  if (!patientSelect.value) return;

  const res = await fetch(
    `${WEBAPP_URL}?action=DOCTOR_GET_NOTES&patient_id=${patientSelect.value}`
  );
  const data = await res.json();

  notes.innerHTML = "";
  data.reverse().forEach(n => {
    const div = document.createElement("div");
    div.className = "note";
    div.innerHTML = `
      <div class="small">${n.time} | ${n.doctor} (${n.type})</div>
      <div>${n.content}</div>
    `;
    notes.appendChild(div);
  });
}

/* ================= SAVE NOTE ================= */
async function saveNote() {
  if (!hid.value || !patientSelect.value || !noteContent.value) {
    alert("Fill required fields");
    return;
  }

  const payload = {
    action: "DOCTOR_SAVE_NOTE",
    hospital_id: hid.value,
    system_patient_id: patientSelect.value,
    note_type: noteType.value,
    content: noteContent.value,
    doctor_name: doctorName.value,
    doctor_reg: doctorReg.value
  };

  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const out = await res.json();

  if (out.status === "SAVED") {
    noteContent.value = "";
    loadNotes();
    alert("Note saved");
  } else {
    alert(out.error || "Save failed");
  }
}
</script>

</body>
</html>