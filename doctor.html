<!DOCTYPE html>
<html>
<head>
  <title>Clinical Notes – Jan Swasthya Seva</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; margin:20px; background:#f4f6f8; }
    h2 { border-bottom:1px solid #ccc; padding-bottom:5px; }
    .section {
      background:#fff;
      padding:15px;
      margin-bottom:20px;
      border-radius:6px;
    }
    label {
      font-weight:bold;
      margin-top:10px;
      display:block;
    }
    input, textarea, select {
      width:100%;
      padding:10px;
      margin-top:5px;
      font-size:15px;
    }
    button {
      width:100%;
      padding:14px;
      background:#007bff;
      color:#fff;
      border:none;
      border-radius:6px;
      font-size:16px;
      cursor:pointer;
    }
  </style>
</head>

<body>

<h2>Clinical Notes</h2>

<!-- Patient selection -->
<div class="section">
  <label>Patient (Admitted Only) *</label>
  <select id="hospitalPatientId"></select>

  <label>Encounter Type *</label>
  <select id="encounterType">
    <option value="OPD">OPD</option>
    <option value="IPD">IPD</option>
  </select>
</div>

<!-- Clinical content -->
<div class="section">
  <label>Chief Complaints</label>
  <textarea id="chiefComplaints"></textarea>

  <label>Comorbidities</label>
  <textarea id="comorbidities"></textarea>

  <label>Examination</label>
  <textarea id="examination"
    placeholder="BP:
HR:
SpO2:
RR:
Temp:
RBS/HGT:

CVS:
RS:
PA:
CNS:

Other:"></textarea>

  <label>Provisional Diagnosis</label>
  <textarea id="provisionalDiagnosis"></textarea>

  <label>Investigations</label>
  <textarea id="investigations"></textarea>

  <label>Treatment</label>
  <textarea id="treatment"></textarea>
</div>

<!-- Doctor / Nurse -->
<div class="section">
  <label>Doctor / Nurse Name *</label>
  <input id="doctorName">

  <label>Registration Number *</label>
  <input id="doctorReg">
</div>

<button onclick="saveNote()">Save Clinical Note</button>

<script>
const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbx_gAByhgJTy9k7KcS983n3vWpoeI2w-QTj0Uq9xZqaCNbWZsUeyX6UngNdL-5L6XJX/exec";

const hid = new URLSearchParams(window.location.search).get("hid");

/* Load admitted patients into dropdown */
async function loadPatients() {
  const res = await fetch(
    WEBAPP_URL + "?action=getAdmittedPatients&hospital_id=" + hid
  );
  const out = await res.json();

  const sel = document.getElementById("hospitalPatientId");
  sel.innerHTML = "";

  if (out.status !== "success" || out.data.length === 0) {
    const opt = document.createElement("option");
    opt.textContent = "No admitted patients";
    opt.disabled = true;
    sel.appendChild(opt);
    return;
  }

  out.data.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.hospital_patient_id;
    opt.textContent =
      p.hospital_patient_id + " — " + p.patient_name;
    sel.appendChild(opt);
  });
}

/* Save clinical note */
async function saveNote() {
  const payload = {
    action: "saveClinicalNote",
    hospital_id: hid,
    hospital_patient_id: hospitalPatientId.value,
    encounter_type: encounterType.value,
    chief_complaints: chiefComplaints.value,
    comorbidities: comorbidities.value,
    examination: examination.value,
    provisional_diagnosis: provisionalDiagnosis.value,
    investigations: investigations.value,
    treatment: treatment.value,
    doctor_name: doctorName.value,
    doctor_reg_no: doctorReg.value
  };

  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const out = await res.json();

  if (out.status === "success") {
    alert("Clinical note saved successfully");
    document.querySelectorAll("textarea").forEach(t => t.value = "");
  } else {
    alert("Error: " + (out.error || "Unable to save note"));
  }
}

loadPatients();
</script>

</body>
</html>
